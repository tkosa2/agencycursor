@page
@model AgencyCursor.Pages.Appointments.CreateModel
@{
    ViewData["Title"] = Model.Request != null ? "Assign Interpreter to Request" : "Schedule Appointment";
}

<h1>@(Model.Request != null ? "Assign Interpreter to Request" : "Schedule Appointment")</h1>
@if (Model.Request != null)
{
    <p class="text-muted">Request #@Model.Request.Id — @Model.Request.Requestor?.Name — @Model.Request.TypeOfService — @Model.Request.ServiceDateTime.ToString("g")</p>
    @if (!string.IsNullOrWhiteSpace(Model.Request.ConsumerNames))
    {
        <p class="text-muted">Consumers: @Model.Request.ConsumerNames</p>
    }
}

<form method="post">
    @if (Model.Request != null)
    {
        <input type="hidden" asp-for="Appointment.RequestId" />
    }
    <div asp-validation-summary="All" class="text-danger"></div>
    @if (Model.Request == null)
    {
        <div class="mb-2">
            <label asp-for="Appointment.RequestId" class="form-label">Request <span class="text-muted">(optional - leave empty for admin-created appointment)</span></label>
            <select asp-for="Appointment.RequestId" class="form-select" asp-items="Model.RequestList">
                <option value="0">-- Optional: Select Request or Leave Empty for Admin-Created --</option>
            </select>
            <span asp-validation-for="Appointment.RequestId" class="text-danger"></span>
        </div>
    }
    <div class="mb-2">
        <label asp-for="SelectedInterpreterIds" class="form-label">Interpreters (Team) <span class="text-danger">*</span></label>
        <select asp-for="SelectedInterpreterIds" class="form-select" asp-items="Model.InterpreterList" multiple>
        </select>
        <small class="form-text text-muted">Select one or more interpreters for this appointment</small>
        <span asp-validation-for="SelectedInterpreterIds" class="text-danger"></span>
    </div>
    <div class="mb-2">
        <label asp-for="Appointment.ServiceDateTime" class="form-label">Date and Time <span class="text-danger">*</span></label>
        <input asp-for="Appointment.ServiceDateTime" class="form-control" type="datetime-local" id="start-datetime" />
        <span asp-validation-for="Appointment.ServiceDateTime" class="text-danger"></span>
    </div>
    <div class="mb-2">
        <label class="form-label">End Date and Time <span class="text-muted">(optional - used to calculate duration)</span></label>
        <input type="datetime-local" id="end-datetime" class="form-control" value="@(Model.RequestEndDateTime?.ToString("yyyy-MM-ddTHH:mm") ?? "")" />
    </div>
    <div class="mb-2">
        <label asp-for="Appointment.Location" class="form-label"></label>
        <select asp-for="Appointment.Location" class="form-select">
            <option value="In-Person">In-Person</option>
            <option value="Virtual">Virtual</option>
        </select>
    </div>
    <div class="mb-2">
        <label asp-for="Appointment.ServiceDetails" class="form-label"></label>
        <input asp-for="Appointment.ServiceDetails" class="form-control" />
    </div>
    <div class="mb-2">
        <label asp-for="Appointment.DurationMinutes" class="form-label"></label>
        <input asp-for="Appointment.DurationMinutes" class="form-control" type="number" />
    </div>
    <div class="mb-2">
        <label asp-for="Appointment.Status" class="form-label"></label>
        <select asp-for="Appointment.Status" class="form-select">
            <option value="Confirmed">Confirmed</option>
            <option value="Completed">Completed</option>
            <option value="Cancelled<48h">Cancelled (Less than 48 hours - Charge Applies)</option>
            <option value="Cancelled>48h">Cancelled (More than 48 hours - No Charge)</option>
        </select>
        <small class="form-text text-muted">
            <strong>Workflow:</strong> Confirmed → Completed
        </small>
    </div>
    <div class="mb-2">
        <label asp-for="Appointment.AdditionalNotes" class="form-label"></label>
        <textarea asp-for="Appointment.AdditionalNotes" class="form-control" rows="3"></textarea>
    </div>
    <button type="submit" class="btn btn-primary">Create Appointment</button>
    <a asp-page="Index" class="btn btn-secondary">Cancel</a>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(function () {
            var startDatetime = $("#start-datetime");
            var endDatetime = $("#end-datetime");
            var durationInput = $("input[name='Appointment.DurationMinutes']");
            var requestIdInput = $("input[name='Appointment.RequestId']");

            // Calculate duration from start and end datetime
            function calculateDuration() {
                var startValue = startDatetime.val();
                var endValue = endDatetime.val();

                if (startValue && endValue) {
                    var start = new Date(startValue);
                    var end = new Date(endValue);
                    
                    if (end > start) {
                        var diffMs = end - start;
                        var diffMinutes = Math.round(diffMs / (1000 * 60));
                        durationInput.val(diffMinutes);
                    }
                }
            }

            // Event handlers
            startDatetime.on("change", calculateDuration);
            endDatetime.on("change", calculateDuration);
            requestIdInput.on("change", populateClientName);

            // Initialize on page load
            populateClientName();
            calculateDuration();
        });
    </script>
}
