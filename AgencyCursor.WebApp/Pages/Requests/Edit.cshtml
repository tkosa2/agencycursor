@page "{id:int}"
@model AgencyCursor.Pages.Requests.EditModel
@{
    ViewData["Title"] = "Edit Request";
}

<h1>Edit Request</h1>

<form method="post">
    <input type="hidden" asp-for="Request.Id" />
    <input type="hidden" asp-for="Request.RequestorId" />
    @if (!ViewData.ModelState.IsValid)
    {
        <div asp-validation-summary="All" class="alert alert-danger mb-3" role="alert"></div>
    }
    <div class="mb-2">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <label class="form-label">Requestor</label>
                <p class="form-control-static">@Model.Request.Requestor?.Name</p>
            </div>
            <a href="@Url.Page("/Requestors/Edit", new { id = Model.Request.RequestorId })" class="btn btn-sm btn-primary">Edit Requestor</a>
        </div>
    </div>
    <div class="mb-2">
        <label asp-for="Request.NumberOfIndividuals" class="form-label">Number of Individuals</label>
        <input asp-for="Request.NumberOfIndividuals" class="form-control" type="number" min="1" max="99" />
    </div>
    <div class="mb-2">
        <label class="form-label">Individual Type</label>
        <div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.IndividualType" value="deaf" id="individual-deaf" />
                <label class="form-check-label" for="individual-deaf">Deaf</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.IndividualType" value="deafblind" id="individual-deafblind" />
                <label class="form-check-label" for="individual-deafblind">Deaf-Blind</label>
            </div>
        </div>
    </div>
    <div class="mb-2">
        <label asp-for="Request.TypeOfService" class="form-label">Type of Service</label>
        <div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.TypeOfService" value="Medical" id="type-medical" />
                <label class="form-check-label" for="type-medical">Medical</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.TypeOfService" value="Legal" id="type-legal" />
                <label class="form-check-label" for="type-legal">Legal</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.TypeOfService" value="Educational" id="type-educational" />
                <label class="form-check-label" for="type-educational">Educational</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.TypeOfService" value="Government" id="type-government" />
                <label class="form-check-label" for="type-government">Government</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.TypeOfService" value="Other" id="type-other" />
                <label class="form-check-label" for="type-other">Other</label>
            </div>
        </div>
        <div class="mb-2" id="other-specify-wrap" style="display: none;">
            <label asp-for="Request.TypeOfServiceOther" class="form-label">Other (Please specify)</label>
            <input asp-for="Request.TypeOfServiceOther" class="form-control" placeholder="Specify type of appointment" />
        </div>
    </div>
    <div class="mb-2">
        <label asp-for="Request.PreferredInterpreterName" class="form-label">Preferred Interpreter</label>
        <input asp-for="Request.PreferredInterpreterName" class="form-control" placeholder="Name of interpreter if any" />
    </div>
    <div class="mb-2">
        <label asp-for="Request.ConsumerNames" class="form-label">Consumer Name(s)</label>
        <textarea asp-for="Request.ConsumerNames" class="form-control" rows="3" placeholder="Enter one or more consumer first and last names (one per line or separated by commas)"></textarea>
        <small class="form-text text-muted">Example: John Smith, Jane Doe or enter one per line</small>
    </div>
    <div class="mb-2">
        <label class="form-label">Mode of Interpretation</label>
        <div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.Mode" value="In-Person" id="mode-inperson" />
                <label class="form-check-label" for="mode-inperson">In-Person</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.Mode" value="Virtual" id="mode-virtual" />
                <label class="form-check-label" for="mode-virtual">Virtual</label>
            </div>
        </div>
    </div>
    <div class="mb-2">
        <label asp-for="Request.ServiceDateTime" class="form-label">Date and Time of Service</label>
        <input asp-for="Request.ServiceDateTime" class="form-control" type="datetime-local" required />
        <span asp-validation-for="Request.ServiceDateTime" class="text-danger"></span>
    </div>
    <div class="mb-2">
        <label asp-for="Request.EndDateTime" class="form-label">End Date and Time</label>
        <input asp-for="Request.EndDateTime" class="form-control" type="datetime-local" readonly />
        <small class="form-text text-muted">Automatically set to 2 hours after start time (minimum interpreter request)</small>
    </div>
    <div class="mb-2">
        <label asp-for="Request.Location" class="form-label">Location</label>
        <select asp-for="Request.Location" id="location-select" class="form-select">
            <option value="In-Person">In-Person</option>
            <option value="Virtual">Virtual</option>
        </select>
    </div>
    <div class="mb-2" id="meeting-link-section" style="display: none;">
        <label asp-for="Request.MeetingLink" class="form-label">Meeting Information</label>
        <textarea asp-for="Request.MeetingLink" class="form-control" rows="5" placeholder="Meeting link: https://...&#10;Passcode: 123456&#10;Phone: +1 (555) 123-4567&#10;Meeting ID: 123 456 7890&#10;Other information..."></textarea>
        <small class="form-text text-muted">You can include meeting link, passcode, phone number, meeting ID, and any other relevant details.</small>
    </div>
    <fieldset class="mb-4" id="inperson-location-section">
        <legend class="h6 mb-2">In-Person Location</legend>
        <div class="mb-2">
            <label asp-for="Request.Address" class="form-label">Address</label>
            <input asp-for="Request.Address" class="form-control" placeholder="Street address" />
        </div>
        <div class="mb-2">
            <label asp-for="Request.Address2" class="form-label">Address 2</label>
            <input asp-for="Request.Address2" class="form-control" placeholder="Apartment, suite, floor, etc." />
        </div>
        <div class="row">
            <div class="col-md-6 mb-2">
                <label asp-for="Request.City" class="form-label">City</label>
                <input asp-for="Request.City" class="form-control" placeholder="City" />
            </div>
            <div class="col-md-3 mb-2">
                <label asp-for="Request.State" class="form-label">State</label>
                <select asp-for="Request.State" class="form-select" asp-items="Model.StateList">
                    <option value="">-- Select State --</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <label asp-for="Request.ZipCode" class="form-label">ZIP Code</label>
                <input asp-for="Request.ZipCode" class="form-control" placeholder="ZIP code" />
            </div>
        </div>
    </fieldset>
    <div class="mb-2">
        <label class="form-label">Gender Preference</label>
        <div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.GenderPreference" value="male" id="gender-male" />
                <label class="form-check-label" for="gender-male">Male</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.GenderPreference" value="female" id="gender-female" />
                <label class="form-check-label" for="gender-female">Female</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.GenderPreference" value="none" id="gender-none" />
                <label class="form-check-label" for="gender-none">No Preference</label>
            </div>
        </div>
    </div>
    <div class="mb-2">
        <label class="form-label">Specializations</label>
        <p class="text-muted mb-2">Please select any that apply:</p>
        <div>
            @{
                var specializations = Model.Request?.Specializations?.Split(", ", StringSplitOptions.RemoveEmptyEntries) ?? Array.Empty<string>();
            }
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="Specializations" value="ASL" id="spec-asl" @(specializations.Contains("ASL") ? "checked" : "") />
                <label class="form-check-label" for="spec-asl">ASL (American Sign Language) Interpreter</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="Specializations" value="CDI" id="spec-cdi" @(specializations.Contains("CDI") ? "checked" : "") />
                <label class="form-check-label" for="spec-cdi">CDI (Certified Deaf Interpreter)</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="Specializations" value="Deaf-Blind" id="spec-deafblind" @(specializations.Contains("Deaf-Blind") ? "checked" : "") />
                <label class="form-check-label" for="spec-deafblind">Deaf-Blind interpreter</label>
            </div>
            <div class="ms-4">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="Specializations" value="Deaf-Blind-Closed-Up" id="spec-deafblind-closed" @(specializations.Contains("Deaf-Blind-Closed-Up") ? "checked" : "") />
                    <label class="form-check-label" for="spec-deafblind-closed">1. Closed up</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="Specializations" value="Deaf-Blind-Tactile" id="spec-deafblind-tactile" @(specializations.Contains("Deaf-Blind-Tactile") ? "checked" : "") />
                    <label class="form-check-label" for="spec-deafblind-tactile">2. Tactile</label>
                </div>
                <div class="ms-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="Specializations" value="Tactile-Left-Hand" id="spec-tactile-left" @(specializations.Contains("Tactile-Left-Hand") ? "checked" : "") />
                        <label class="form-check-label" for="spec-tactile-left">left hand</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="Specializations" value="Tactile-Right-Hand" id="spec-tactile-right" @(specializations.Contains("Tactile-Right-Hand") ? "checked" : "") />
                        <label class="form-check-label" for="spec-tactile-right">right hand</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="Specializations" value="Tactile-Both-Hands" id="spec-tactile-both" @(specializations.Contains("Tactile-Both-Hands") ? "checked" : "") />
                        <label class="form-check-label" for="spec-tactile-both">both hands</label>
                    </div>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="Specializations" value="Deaf-Blind-Tracking" id="spec-deafblind-tracking" @(specializations.Contains("Deaf-Blind-Tracking") ? "checked" : "") />
                    <label class="form-check-label" for="spec-deafblind-tracking">3. tracking</label>
                </div>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="Specializations" value="Universal" id="spec-universal" @(specializations.Contains("Universal") ? "checked" : "") />
                <label class="form-check-label" for="spec-universal">Universal Sign Language Interpreter</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" name="Specializations" value="International" id="spec-international" @(specializations.Contains("International") ? "checked" : "") />
                <label class="form-check-label" for="spec-international">International Interpreter (If available)</label>
            </div>
            <div class="ms-4">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="Specializations" value="International-Russia" id="spec-russia" @(specializations.Contains("International-Russia") ? "checked" : "") />
                    <label class="form-check-label" for="spec-russia">Russia</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="Specializations" value="International-Spanish" id="spec-spanish" @(specializations.Contains("International-Spanish") ? "checked" : "") />
                    <label class="form-check-label" for="spec-spanish">Spanish</label>
                </div>
                <div class="mb-2">
                    <label asp-for="Request.InternationalOther" class="form-label small">Other:</label>
                    <input asp-for="Request.InternationalOther" class="form-control form-control-sm" placeholder="Specify other international interpreter" />
                </div>
            </div>
            <div class="mb-2">
                <label asp-for="Request.OtherInterpreter" class="form-label">Other interpreter:</label>
                <input asp-for="Request.OtherInterpreter" class="form-control" placeholder="Specify other interpreter type" />
            </div>
        </div>
    </div>
    <div class="mb-2">
        <label asp-for="Request.AdditionalNotes" class="form-label">Additional Notes</label>
        <textarea asp-for="Request.AdditionalNotes" class="form-control" rows="3"></textarea>
    </div>
    <div class="mb-2">
        <label asp-for="Request.Status" class="form-label"></label>
        <select asp-for="Request.Status" class="form-select">
            <option value="New Request">New Request</option>
            <option value="Reviewed">Reviewed</option>
            <option value="Approved">Approved</option>
            <option value="Broadcasted">Broadcasted</option>
        </select>
        <small class="form-text text-muted">
            <strong>Workflow:</strong> New Request → Reviewed → Approved → Broadcasted
        </small>
    </div>
    <button type="submit" class="btn btn-primary">Save</button>
    <a asp-page="Index" class="btn btn-secondary">Cancel</a>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(function () {
            var form = $("form");
            var locationSelect = $("#location-select");
            var meetingLinkSection = $("#meeting-link-section");
            var inpersonLocationSection = $("#inperson-location-section");
            var modeInPerson = $("#mode-inperson");
            var modeVirtual = $("#mode-virtual");
            var typeOther = $("#type-other");
            var otherWrap = $("#other-specify-wrap");

            // Toggle meeting link section based on location
            function toggleMeetingLink() {
                var isVirtual = locationSelect.val() === "Virtual";
                meetingLinkSection.toggle(isVirtual);
            }

            // Toggle virtual/in-person sections based on Mode
            function toggleMode() {
                var isVirtual = modeVirtual.is(":checked");
                meetingLinkSection.toggle(isVirtual);
                inpersonLocationSection.toggle(!isVirtual);
                // Update Location dropdown to match Mode
                if (isVirtual) {
                    locationSelect.val("Virtual");
                } else {
                    locationSelect.val("In-Person");
                }
                toggleMeetingLink();
            }

            // Toggle "Other" type of service field
            function toggleOtherService() {
                otherWrap.toggle(typeOther.is(":checked"));
            }

            // Initialize on page load
            toggleMeetingLink();
            toggleMode();
            toggleOtherService();

            // Auto-update end date/time to be 2 hours after start date/time
            var serviceDateTimeInput = $("input[name='Request.ServiceDateTime']");
            var endDateTimeInput = $("input[name='Request.EndDateTime']");
            
            function updateEndDateTime() {
                if (serviceDateTimeInput.val()) {
                    var startDateTime = new Date(serviceDateTimeInput.val());
                    if (!isNaN(startDateTime.getTime())) {
                        // Add 2 hours
                        var endDateTime = new Date(startDateTime.getTime() + (2 * 60 * 60 * 1000));
                        // Format for datetime-local input: YYYY-MM-DDTHH:mm
                        var year = endDateTime.getFullYear();
                        var month = String(endDateTime.getMonth() + 1).padStart(2, '0');
                        var day = String(endDateTime.getDate()).padStart(2, '0');
                        var hours = String(endDateTime.getHours()).padStart(2, '0');
                        var minutes = String(endDateTime.getMinutes()).padStart(2, '0');
                        var formattedDateTime = year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
                        endDateTimeInput.val(formattedDateTime);
                    }
                }
            }
            
            serviceDateTimeInput.on("change input", updateEndDateTime);
            // Set initial value
            updateEndDateTime();

            // Update when location changes
            locationSelect.on("change", toggleMeetingLink);
            
            // Update when mode changes
            modeInPerson.on("change", toggleMode);
            modeVirtual.on("change", toggleMode);
            
            // Update when type of service changes
            $("input[name='Request.TypeOfService']").on("change", toggleOtherService);

            // Ensure unobtrusive validation is initialized for the form
            $.validator.unobtrusive.parse(form);

            // Validate only on submit; don't clear validator state or classes
            form.on("submit", function (e) {
                if (!form.valid()) {
                    e.preventDefault();
                    return false;
                }
            });

            // When user changes a field, re-validate that field to update its message
            form.find("input, select, textarea").on("input change", function () {
                var field = $(this);
                // Trigger validation for the specific field without wiping global validator state
                field.valid();
            });
        });
    </script>
}
