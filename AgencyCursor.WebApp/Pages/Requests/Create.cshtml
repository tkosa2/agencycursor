@page
@model AgencyCursor.Pages.Requests.CreateModel
@{
    ViewData["Title"] = "Request an Interpreter";
}

<h1>Request an Interpreter</h1>
<p>Submit your request for a qualified sign language or DeafBlind interpreter. We will respond as soon as possible.</p>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<form method="post" class="needs-validation" novalidate>
    @if (!ViewData.ModelState.IsValid)
    {
        <div asp-validation-summary="All" class="alert alert-danger mb-3" role="alert"></div>
    }

    <!-- 1. Requestor Information -->
    <fieldset class="mb-4">
        <legend class="h5 mb-3">1. Requestor Information</legend>
        <div class="mb-3" style="position: relative;">
            <label for="requestor-search" class="form-label">
                Search Existing Requestor <span class="text-muted">(optional - start typing to search)</span>
            </label>
            <input type="text" id="requestor-search" class="form-control" placeholder="Type to search by name, email, or phone..." autocomplete="off" />
            <div id="requestor-suggestions" class="list-group" style="position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto; display: none; width: 100%; margin-top: 2px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);"></div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label asp-for="RequestorFirstName" class="form-label">
                    First Name <span class="text-danger">*</span>
                </label>
                <input asp-for="RequestorFirstName" id="requestor-first-name" class="form-control" placeholder="First name" required />
                <span asp-validation-for="RequestorFirstName" class="text-danger"></span>
            </div>
            <div class="col-md-6">
                <label asp-for="RequestorLastName" class="form-label">
                    Last Name <span class="text-danger">*</span>
                </label>
                <input asp-for="RequestorLastName" id="requestor-last-name" class="form-control" placeholder="Last name" required />
                <span asp-validation-for="RequestorLastName" class="text-danger"></span>
            </div>
        </div>
        <div class="mb-3">
            <label for="request-name" class="form-label">
                Full Name <span class="text-muted">(auto-filled)</span>
            </label>
            <input type="text" id="request-name" class="form-control" readonly />
        </div>
        <div class="mb-3">
            <label asp-for="Request.RequestName" class="form-label">
                Request Name <span class="text-muted">(optional)</span>
            </label>
            <input asp-for="Request.RequestName" class="form-control" placeholder="Name for this request" />
            <span asp-validation-for="Request.RequestName" class="text-danger"></span>
        </div>
        <div class="mb-3">
            <label asp-for="Request.NumberOfIndividuals" class="form-label">
                Number of Deaf or Deaf-Blind Individuals <span class="text-danger">*</span>
            </label>
            <input asp-for="Request.NumberOfIndividuals" class="form-control" type="number" min="1" max="99" value="1" required />
            <span asp-validation-for="Request.NumberOfIndividuals" class="text-danger"></span>
        </div>
        <div class="mb-3">
            <p class="mb-2">Please specify if the individual is Deaf or Deaf-Blind:</p>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.IndividualType" value="deaf" id="individual-deaf" checked />
                <label class="form-check-label" for="individual-deaf">Deaf</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.IndividualType" value="deafblind" id="individual-deafblind" />
                <label class="form-check-label" for="individual-deafblind">Deaf-Blind</label>
            </div>
        </div>
    </fieldset>

    <!-- 2. Contact Information -->
    <fieldset class="mb-4">
        <legend class="h5 mb-3">2. Contact Information</legend>
        <div class="mb-3">
            <label asp-for="RequestorPhone" class="form-label">
                Phone Number <span class="text-danger">*</span>
            </label>
            <input asp-for="RequestorPhone" class="form-control" type="tel" required />
            <span asp-validation-for="RequestorPhone" class="text-danger"></span>
        </div>
        <div class="mb-3">
            <label asp-for="RequestorEmail" class="form-label">
                Email Address <span class="text-danger">*</span>
            </label>
            <input asp-for="RequestorEmail" class="form-control" type="email" required />
            <span asp-validation-for="RequestorEmail" class="text-danger"></span>
        </div>
    </fieldset>

    <!-- 3. Appointment Details -->
    <fieldset class="mb-4">
        <legend class="h5 mb-3">3. Appointment Details</legend>
        <div class="mb-3">
            <label asp-for="AppointmentDate" class="form-label">
                Date of Appointment <span class="text-danger">*</span>
            </label>
            <input asp-for="AppointmentDate" class="form-control" type="date" required />
            <span asp-validation-for="AppointmentDate" class="text-danger"></span>
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label asp-for="StartTime" class="form-label">
                    Start Time <span class="text-danger">*</span>
                </label>
                <input asp-for="StartTime" class="form-control" type="time" required />
                <span asp-validation-for="StartTime" class="text-danger"></span>
            </div>
            <div class="col-md-6 mb-3">
                <label asp-for="EndTime" class="form-label">
                    End Time <span class="text-danger">*</span>
                </label>
                <input asp-for="EndTime" class="form-control" type="time" readonly />
                <small class="form-text text-muted">Automatically set to 2 hours after start time (minimum interpreter request)</small>
            </div>
        </div>
    </fieldset>

    <!-- 4. Type of Appointment -->
    <fieldset class="mb-4">
        <legend class="h5 mb-3">4. Type of Appointment</legend>
        <p class="mb-2">Please select one:</p>
        <div class="mb-3">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.TypeOfService" value="Medical" id="type-medical" />
                <label class="form-check-label" for="type-medical">Medical</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.TypeOfService" value="Legal" id="type-legal" />
                <label class="form-check-label" for="type-legal">Legal</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.TypeOfService" value="Educational" id="type-educational" />
                <label class="form-check-label" for="type-educational">Educational</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.TypeOfService" value="Other" id="type-other" />
                <label class="form-check-label" for="type-other">Other</label>
            </div>
        </div>
        <div class="mb-3" id="other-specify-wrap" style="display:none;">
            <label asp-for="Request.TypeOfServiceOther" class="form-label">Other (Please specify)</label>
            <input asp-for="Request.TypeOfServiceOther" class="form-control" placeholder="Specify type of appointment" />
        </div>
    </fieldset>

    <!-- 5. Mode of Interpretation -->
    <fieldset class="mb-4">
        <legend class="h5 mb-3">5. Mode of Interpretation</legend>
        <p class="mb-2">Please select one:</p>
        <div class="mb-3">
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.Mode" value="In-Person" id="mode-inperson" checked />
                <label class="form-check-label" for="mode-inperson">In-Person</label>
            </div>
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" asp-for="Request.Mode" value="Virtual" id="mode-virtual" />
                <label class="form-check-label" for="mode-virtual">Virtual (Please provide the link below)</label>
            </div>
        </div>
    </fieldset>

    <!-- 6. Virtual Appointment Link -->
    <fieldset class="mb-4" id="virtual-link-section" style="display:none;">
        <legend class="h5 mb-3">6. Virtual Appointment Information</legend>
        <p class="text-muted mb-3">If virtual, provide meeting details including link, passcode, phone number, meeting ID, and any other relevant information.</p>
        <div class="mb-3">
            <label asp-for="Request.MeetingLink" class="form-label">Meeting Information</label>
            <textarea asp-for="Request.MeetingLink" class="form-control" rows="5" placeholder="Meeting link: https://...&#10;Passcode: 123456&#10;Phone: +1 (555) 123-4567&#10;Meeting ID: 123 456 7890&#10;Other information..."></textarea>
            <small class="form-text text-muted">You can include meeting link, passcode, phone number, meeting ID, and any other relevant details.</small>
        </div>
    </fieldset>

    <!-- 7. In-Person Appointment Location -->
    <fieldset class="mb-4" id="inperson-location-section">
        <legend class="h5 mb-3">7. In-Person Appointment Location</legend>
        <p class="text-muted mb-3">Please include floor/suite if applicable.</p>
        <div class="mb-3">
            <label asp-for="Request.Address" class="form-label">
                Address <span class="text-danger">*</span>
            </label>
            <input asp-for="Request.Address" class="form-control" placeholder="Street address" required />
            <span asp-validation-for="Request.Address" class="text-danger"></span>
        </div>
        <div class="mb-3">
            <label asp-for="Request.Address2" class="form-label">Address 2</label>
            <input asp-for="Request.Address2" class="form-control" placeholder="Apartment, suite, floor, etc." />
        </div>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label asp-for="Request.City" class="form-label">
                    City <span class="text-danger">*</span>
                </label>
                <input asp-for="Request.City" class="form-control" placeholder="City" required />
                <span asp-validation-for="Request.City" class="text-danger"></span>
            </div>
            <div class="col-md-3 mb-3">
                <label asp-for="Request.State" class="form-label">
                    State <span class="text-danger">*</span>
                </label>
                <select asp-for="Request.State" class="form-select" asp-items="Model.StateList" required>
                    <option value="">-- Select State --</option>
                </select>
                <span asp-validation-for="Request.State" class="text-danger"></span>
            </div>
            <div class="col-md-3 mb-3">
                <label asp-for="Request.ZipCode" class="form-label">
                    ZIP Code <span class="text-danger">*</span>
                </label>
                <input asp-for="Request.ZipCode" class="form-control" placeholder="ZIP code" pattern="[0-9]{5}(-[0-9]{4})?" title="5-digit ZIP code or ZIP+4" required />
                <span asp-validation-for="Request.ZipCode" class="text-danger"></span>
            </div>
        </div>
    </fieldset>

    <!-- 8. Interpreter Preferences -->
    <fieldset class="mb-4">
        <legend class="h5 mb-3">8. Interpreter Preferences</legend>
        <div class="mb-3">
            <label class="form-label">Gender Preference</label>
            <div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" asp-for="Request.GenderPreference" value="male" id="gender-male" />
                    <label class="form-check-label" for="gender-male">Male</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" asp-for="Request.GenderPreference" value="female" id="gender-female" />
                    <label class="form-check-label" for="gender-female">Female</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" asp-for="Request.GenderPreference" value="none" id="gender-none" checked />
                    <label class="form-check-label" for="gender-none">No Preference</label>
                </div>
            </div>
        </div>
        <div class="mb-3">
            <label asp-for="Request.PreferredInterpreterName" class="form-label">
                Preferred Interpreter <span class="text-muted">(optional)</span>
            </label>
            <input asp-for="Request.PreferredInterpreterName" class="form-control" placeholder="Name of interpreter if any" />
        </div>
        <div class="mb-3">
            <label class="form-label">Specialization</label>
            <p class="text-muted mb-2">Please select any that apply:</p>
            <div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="Specializations" value="ASL" id="spec-asl" />
                    <label class="form-check-label" for="spec-asl">ASL (American Sign Language) Interpreter</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="Specializations" value="CDI" id="spec-cdi" />
                    <label class="form-check-label" for="spec-cdi">CDI (Certified Deaf Interpreter)</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="Specializations" value="Deaf-Blind" id="spec-deafblind" />
                    <label class="form-check-label" for="spec-deafblind">Deaf-Blind interpreter</label>
                </div>
                <div class="ms-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="Specializations" value="Deaf-Blind-Closed-Up" id="spec-deafblind-closed" />
                        <label class="form-check-label" for="spec-deafblind-closed">1. Closed up</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="Specializations" value="Deaf-Blind-Tactile" id="spec-deafblind-tactile" />
                        <label class="form-check-label" for="spec-deafblind-tactile">2. Tactile</label>
                    </div>
                    <div class="ms-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="Specializations" value="Tactile-Left-Hand" id="spec-tactile-left" />
                            <label class="form-check-label" for="spec-tactile-left">left hand</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="Specializations" value="Tactile-Right-Hand" id="spec-tactile-right" />
                            <label class="form-check-label" for="spec-tactile-right">right hand</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="Specializations" value="Tactile-Both-Hands" id="spec-tactile-both" />
                            <label class="form-check-label" for="spec-tactile-both">both hands</label>
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="Specializations" value="Deaf-Blind-Tracking" id="spec-deafblind-tracking" />
                        <label class="form-check-label" for="spec-deafblind-tracking">3. tracking</label>
                    </div>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="Specializations" value="Universal" id="spec-universal" />
                    <label class="form-check-label" for="spec-universal">Universal Sign Language Interpreter</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="Specializations" value="International" id="spec-international" />
                    <label class="form-check-label" for="spec-international">International Interpreter (If available)</label>
                </div>
                <div class="ms-4">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="Specializations" value="International-Russia" id="spec-russia" />
                        <label class="form-check-label" for="spec-russia">Russia</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="Specializations" value="International-Spanish" id="spec-spanish" />
                        <label class="form-check-label" for="spec-spanish">Spanish</label>
                    </div>
                    <div class="mb-2">
                        <label asp-for="Request.InternationalOther" class="form-label small">Other:</label>
                        <input asp-for="Request.InternationalOther" class="form-control form-control-sm" placeholder="Specify other international interpreter" />
                    </div>
                </div>
                <div class="mb-2">
                    <label asp-for="Request.OtherInterpreter" class="form-label">Other interpreter:</label>
                    <input asp-for="Request.OtherInterpreter" class="form-control" placeholder="Specify other interpreter type" />
                </div>
            </div>
        </div>
    </fieldset>

    <!-- 9. Additional Information/Notes -->
    <fieldset class="mb-4">
        <legend class="h5 mb-3">9. Additional Information/Notes</legend>
        <p class="text-muted mb-2">Any special requests or considerations for the interpreter?</p>
        <div class="mb-3">
            <label asp-for="Request.AdditionalNotes" class="form-label">Notes</label>
            <textarea asp-for="Request.AdditionalNotes" class="form-control" rows="4" placeholder="Special requests, accessibility needs, etc."></textarea>
        </div>
    </fieldset>

    <div class="mb-3">
        <button type="submit" class="btn btn-primary">Submit request</button>
        <a asp-page="Index" class="btn btn-secondary">Cancel</a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        (function() {
            // Toggle virtual/in-person sections
            var modeInPerson = document.getElementById('mode-inperson');
            var modeVirtual = document.getElementById('mode-virtual');
            var virtualSection = document.getElementById('virtual-link-section');
            var inpersonSection = document.getElementById('inperson-location-section');
            var addressInput = document.getElementById('Request_Address');
            var cityInput = document.getElementById('Request_City');
            var stateSelect = document.querySelector('select[name="Request.State"]');
            var zipInput = document.getElementById('Request_ZipCode');

            function toggleMode() {
                var isVirtual = modeVirtual.checked;
                virtualSection.style.display = isVirtual ? 'block' : 'none';
                inpersonSection.style.display = isVirtual ? 'none' : 'block';
                if (addressInput) addressInput.required = !isVirtual;
                if (cityInput) cityInput.required = !isVirtual;
                if (stateSelect) stateSelect.required = !isVirtual;
                if (zipInput) zipInput.required = !isVirtual;
            }

            if (modeInPerson) modeInPerson.addEventListener('change', toggleMode);
            if (modeVirtual) modeVirtual.addEventListener('change', toggleMode);
            toggleMode();

            // Auto-update end time to be 2 hours after start time
            var startTimeInput = document.querySelector('input[name="StartTime"]');
            var endTimeInput = document.querySelector('input[name="EndTime"]');
            
            function updateEndTime() {
                if (startTimeInput && endTimeInput && startTimeInput.value) {
                    var timeParts = startTimeInput.value.split(':');
                    if (timeParts.length >= 2) {
                        var hours = parseInt(timeParts[0], 10);
                        var minutes = parseInt(timeParts[1], 10);
                        // Add 2 hours
                        hours = (hours + 2) % 24;
                        // Format with leading zeros
                        var endHours = hours.toString().padStart(2, '0');
                        var endMinutes = minutes.toString().padStart(2, '0');
                        endTimeInput.value = endHours + ':' + endMinutes;
                    }
                }
            }
            
            if (startTimeInput) {
                startTimeInput.addEventListener('change', updateEndTime);
                startTimeInput.addEventListener('input', updateEndTime);
                // Set initial value
                updateEndTime();
            }

            // Toggle "Other" appointment type field
            var typeOther = document.getElementById('type-other');
            var otherWrap = document.getElementById('other-specify-wrap');
            if (typeOther && otherWrap) {
                typeOther.addEventListener('change', function() {
                    otherWrap.style.display = typeOther.checked ? 'block' : 'none';
                });
            }

            // Auto-fill full name from first and last name
            var requestorFirstNameInput = document.getElementById('requestor-first-name');
            var requestorLastNameInput = document.getElementById('requestor-last-name');
            var requestNameInput = document.getElementById('request-name');
            
            function updateFullName() {
                var firstName = requestorFirstNameInput ? requestorFirstNameInput.value.trim() : '';
                var lastName = requestorLastNameInput ? requestorLastNameInput.value.trim() : '';
                var fullName = (firstName + ' ' + lastName).trim();
                if (requestNameInput) {
                    requestNameInput.value = fullName;
                }
            }
            
            if (requestorFirstNameInput) {
                requestorFirstNameInput.addEventListener('input', updateFullName);
            }
            if (requestorLastNameInput) {
                requestorLastNameInput.addEventListener('input', updateFullName);
            }
            updateFullName();

            // Requestor autocomplete
            var requestorSearch = document.getElementById('requestor-search');
            var requestorSuggestions = document.getElementById('requestor-suggestions');
            var requestorPhoneInput = document.getElementById('RequestorPhone');
            var requestorEmailInput = document.getElementById('RequestorEmail');
            var searchTimeout;

            if (requestorSearch && requestorSuggestions) {

                requestorSearch.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    var term = this.value.trim();

                    if (term.length < 2) {
                        requestorSuggestions.style.display = 'none';
                        return;
                    }

                    searchTimeout = setTimeout(function() {
                        fetch('/Requests/SearchRequestors?term=' + encodeURIComponent(term))
                            .then(response => response.json())
                            .then(data => {
                                requestorSuggestions.innerHTML = '';
                                if (data.length === 0) {
                                    requestorSuggestions.style.display = 'none';
                                    return;
                                }

                                data.forEach(function(requestor) {
                                    var item = document.createElement('a');
                                    item.className = 'list-group-item list-group-item-action';
                                    item.href = '#';
                                    item.innerHTML = '<strong>' + requestor.name + '</strong><br>' +
                                        '<small class="text-muted">' +
                                        (requestor.email ? requestor.email + ' â€¢ ' : '') +
                                        (requestor.phone || '') +
                                        '</small>';
                                    item.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        // Split name into first and last
                                        var nameParts = requestor.name.split(' ');
                                        var firstName = nameParts[0] || '';
                                        var lastName = nameParts.slice(1).join(' ') || '';
                                        if (requestorFirstNameInput) requestorFirstNameInput.value = firstName;
                                        if (requestorLastNameInput) requestorLastNameInput.value = lastName;
                                        updateFullName();
                                        if (requestorPhoneInput) requestorPhoneInput.value = requestor.phone || '';
                                        if (requestorEmailInput) requestorEmailInput.value = requestor.email || '';
                                        requestorSearch.value = requestor.name;
                                        requestorSuggestions.style.display = 'none';
                                    });
                                    requestorSuggestions.appendChild(item);
                                });
                                requestorSuggestions.style.display = 'block';
                            })
                            .catch(error => {
                                console.error('Error searching requestors:', error);
                            });
                    }, 300);
                });

                // Hide suggestions when clicking outside
                document.addEventListener('click', function(e) {
                    if (!requestorSearch.contains(e.target) && !requestorSuggestions.contains(e.target)) {
                        requestorSuggestions.style.display = 'none';
                    }
                });

                // Hide suggestions on escape key
                requestorSearch.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        requestorSuggestions.style.display = 'none';
                    }
                });
            }

            // ZIP code auto-populate
            var zipCodeInput = document.querySelector('input[name="Request.ZipCode"]');
            var cityInput = document.querySelector('input[name="Request.City"]');
            var stateSelectDropdown = document.querySelector('select[name="Request.State"]');
            var zipCodeTimeout;

            if (zipCodeInput && cityInput && stateSelectDropdown) {
                zipCodeInput.addEventListener('input', function() {
                    clearTimeout(zipCodeTimeout);
                    var zip = this.value.trim();

                    // Only search if we have at least 5 digits
                    var zipDigits = zip.replace(/\D/g, '');
                    if (zipDigits.length < 5) {
                        return;
                    }

                    zipCodeTimeout = setTimeout(function() {
                        fetch('/Requests/SearchZipCodes?zip=' + encodeURIComponent(zip))
                            .then(response => response.json())
                            .then(data => {
                                if (data && data.city) {
                                    // Only auto-fill if fields are empty or user hasn't manually changed them
                                    if (!cityInput.dataset.manualEdit) {
                                        cityInput.value = data.city;
                                    }
                                    if (!stateSelectDropdown.dataset.manualEdit && data.state) {
                                        // Set the state dropdown value
                                        var stateValue = data.state.toUpperCase();
                                        stateSelectDropdown.value = stateValue;
                                        // Trigger change event to clear any errors
                                        stateSelectDropdown.dispatchEvent(new Event('change'));
                                    }
                                }
                            })
                            .catch(error => {
                                console.error('Error searching zip codes:', error);
                            });
                    }, 500); // Wait 500ms after user stops typing
                });

                // Track manual edits to city and state
                cityInput.addEventListener('input', function() {
                    if (this.value.trim().length > 0) {
                        this.dataset.manualEdit = 'true';
                    } else {
                        delete this.dataset.manualEdit;
                    }
                });

                stateSelectDropdown.addEventListener('change', function() {
                    if (this.value && this.value.trim().length > 0) {
                        this.dataset.manualEdit = 'true';
                    } else {
                        delete this.dataset.manualEdit;
                    }
                });
            }
        })();
    </script>
}
