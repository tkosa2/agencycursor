@page
@model AgencyCursor.Pages.Interpreters.IndexModel
@{
    ViewData["Title"] = "Search the Registry";
}

<h1>Interpreter Registry</h1>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="mb-3">
    <a asp-page="Index" asp-route-registeredOnly="false" class="btn btn-outline-primary @(!Model.ShowRegisteredOnly ? "active" : "")">Search RID Registry</a>
    <a asp-page="Index" asp-route-registeredOnly="true" class="btn btn-outline-success @(Model.ShowRegisteredOnly ? "active" : "")">View Registered Interpreters</a>
    @if (Model.ShowRegisteredOnly)
    {
        <a asp-page="Create" class="btn btn-outline-secondary ms-2">Add Manual Entry</a>
    }
</div>

@if (!Model.ShowRegisteredOnly)
{
    <p class="text-muted">
        The use of the registry is for individual consumers to contact individual interpreters for interpreting assignments ONLY. 
        These search results can change daily. To ensure the most accurate and up to date information, please DO NOT copy names and store them in an external database.
    </p>

    <div class="alert alert-warning">
        <strong>NOTE:</strong> If the member does not have "Freelance" status indicated, please do not contact them regarding assignments.<br>
        If you are looking to hire an interpreter keep the Category as Certified.
    </div>
}
else
{
    <p class="text-muted">Interpreters registered with the agency. Click "Search RID Registry" to find and register new interpreters.</p>
}

<form method="get" class="needs-validation" novalidate>
    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="FirstName" class="form-label">First Name <span class="text-muted small">[optional]</span></label>
                <input type="text" asp-for="FirstName" class="form-control" id="FirstName" />
            </div>

            <div class="mb-3">
                <label for="LastName" class="form-label">Last Name <span class="text-muted small">[optional]</span></label>
                <input type="text" asp-for="LastName" class="form-control" id="LastName" />
            </div>

            <div class="mb-3">
                <label for="Email" class="form-label">Email <span class="text-muted small">[optional]</span></label>
                <input type="email" asp-for="Email" class="form-control" id="Email" />
            </div>

            <div class="mb-3">
                <label for="City" class="form-label">City <span class="text-muted small">[optional]</span></label>
                <input type="text" asp-for="City" class="form-control" id="City" />
            </div>

            <div class="mb-3">
                <label for="State" class="form-label">State <span class="text-muted small">[optional]</span></label>
                <select asp-for="State" class="form-select" id="State">
                    <option value="">-- Select State --</option>
                    <option value="AL">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="DC">District of Columbia</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MD">Maryland</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NE">Nebraska</option>
                    <option value="NV">Nevada</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NM">New Mexico</option>
                    <option value="NY">New York</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="VA">Virginia</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                </select>
            </div>
        </div>

        <div class="col-md-6">
            <div class="mb-3">
                <label for="ZipCode" class="form-label">Zip Code <span class="text-muted small">[optional]</span></label>
                <input type="text" asp-for="ZipCode" class="form-control" id="ZipCode" pattern="[0-9]{5}" maxlength="5" />
            </div>

            <div class="mb-3">
                <label for="Category" class="form-label">Category</label>
                <select asp-for="Category" class="form-select" id="Category">
                    <option value="">-- Select Category --</option>
                    <option value="Associate">Associate</option>
                    <option value="Student">Student</option>
                    <option value="Certified" selected>Certified</option>
                    <option value="Supporting">Supporting</option>
                    <option value="Certified: Inactive">Certified: Inactive</option>
                    <option value="Certified: Retired">Certified: Retired</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="FreelanceStatus" class="form-label">Freelance Status <span class="text-muted small">[optional]</span></label>
                <select asp-for="FreelanceStatus" class="form-select" id="FreelanceStatus">
                    <option value="">-- Select --</option>
                    <option value="1">Yes</option>
                    <option value="0">No</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="Gender" class="form-label">Gender <span class="text-muted small">[optional]</span></label>
                <select asp-for="Gender" class="form-select" id="Gender">
                    <option value="">-- Select --</option>
                    <option value="1">Male</option>
                    <option value="2">Female</option>
                    <option value="533470000">Non-Binary</option>
                    <option value="533470001">Prefer to Self-Describe</option>
                    <option value="416250000">Trans Man</option>
                    <option value="416250001">Trans Woman</option>
                    <option value="416250002">Genderqueer</option>
                    <option value="416250003">Non-Binary</option>
                    <option value="416250004">Intersex</option>
                    <option value="416250005">Two Spirit</option>
                    <option value="416250006">Agender</option>
                    <option value="416250007">Questioning</option>
                    <option value="416250008">Queer</option>
                    <option value="416250009">Gender Fluid</option>
                    <option value="416250010">Transgender</option>
                    <option value="533470002">Prefer Not to Answer</option>
                </select>
            </div>
        </div>
    </div>

    <div class="mb-3">
        <button type="submit" class="btn btn-primary">Find Member</button>
        <a asp-page="Index" class="btn btn-secondary">Clear</a>
    </div>
</form>

@if (Model.ShowRegisteredOnly)
{
    <hr />
    <h2>Registered Interpreters</h2>
    
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Bulk Register from RID Database</h5>
        </div>
        <div class="card-body">
            <p class="text-muted">Search and register interpreters from the external RID interpreter registry database.</p>
            <form method="post" asp-page-handler="BulkRegister" class="row g-3">
                <div class="col-md-3">
                    <label for="bulkState" class="form-label">State (optional)</label>
                    <input type="text" class="form-control" id="bulkState" name="state" placeholder="e.g., WA" />
                </div>
                <div class="col-md-3">
                    <label for="bulkCity" class="form-label">City (optional)</label>
                    <input type="text" class="form-control" id="bulkCity" name="city" placeholder="e.g., Seattle" />
                </div>
                <div class="col-md-3">
                    <label for="bulkLimit" class="form-label">Limit (optional)</label>
                    <input type="number" class="form-control" id="bulkLimit" name="limit" placeholder="e.g., 100" min="1" max="10000" />
                    <small class="form-text text-muted">Leave empty for default (10000)</small>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100" onclick="return confirm('This will search and register interpreters from the RID database. This may take a while. Continue?');">
                        <i class="bi bi-download"></i> Bulk Register
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    @if (Model.RegisteredInterpreters.Any())
    {
        <p class="text-muted">Found @Model.RegisteredInterpreters.Count registered interpreter(s)</p>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Languages</th>
                        <th>Certification</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var interpreter in Model.RegisteredInterpreters)
                    {
                        <tr>
                            <td><a asp-page="Details" asp-route-id="@interpreter.Id">@interpreter.Name</a></td>
                            <td>@(interpreter.Email ?? "N/A")</td>
                            <td>@(interpreter.Phone ?? "N/A")</td>
                            <td>@(interpreter.Languages ?? "N/A")</td>
                            <td>@(interpreter.Certification ?? "N/A")</td>
                            <td>
                                <a asp-page="Edit" asp-route-id="@interpreter.Id" class="btn btn-sm btn-outline-primary">Edit</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            No interpreters registered yet. Use the search form to find and register interpreters from the RID database.
        </div>
    }
}
else if (Model.HasSearched)
{
    <hr />
    <h2>Search Results</h2>
    @if (Model.RidSearchResults.Any())
    {
        <p class="text-muted">Found @Model.RidSearchResults.Count result(s). Click "Register" to import an interpreter to the agency database.</p>
        
        @* Debug: Show available columns for first result *@
        @if (Model.RidSearchResults.FirstOrDefault() != null)
        {
            <details class="mb-3">
                <summary class="text-muted small">Debug: Available columns (click to expand)</summary>
                <div class="small text-muted mt-2">
                    <strong>Columns found:</strong> 
                    @string.Join(", ", Model.RidSearchResults.First().Keys.OrderBy(k => k))
                </div>
            </details>
        }
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>City</th>
                        <th>State</th>
                        <th>Certification</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var interpreter in Model.RidSearchResults)
                    {
                        <tr>
                            <td>
                                @{
                                    // Try to find name in various column name patterns
                                    var nameKey = interpreter.Keys.FirstOrDefault(k => 
                                        k.Equals("Name", StringComparison.OrdinalIgnoreCase) ||
                                        k.Equals("FullName", StringComparison.OrdinalIgnoreCase) ||
                                        k.Contains("Name", StringComparison.OrdinalIgnoreCase));
                                    
                                    var firstNameKey = interpreter.Keys.FirstOrDefault(k => 
                                        k.Contains("First", StringComparison.OrdinalIgnoreCase) && 
                                        k.Contains("Name", StringComparison.OrdinalIgnoreCase));
                                    
                                    var lastNameKey = interpreter.Keys.FirstOrDefault(k => 
                                        k.Contains("Last", StringComparison.OrdinalIgnoreCase) && 
                                        k.Contains("Name", StringComparison.OrdinalIgnoreCase));
                                    
                                    string name = "N/A";
                                    if (!string.IsNullOrEmpty(nameKey) && interpreter[nameKey] != null)
                                    {
                                        name = interpreter[nameKey]?.ToString()?.Trim() ?? "N/A";
                                    }
                                    else if (!string.IsNullOrEmpty(firstNameKey) || !string.IsNullOrEmpty(lastNameKey))
                                    {
                                        var firstName = !string.IsNullOrEmpty(firstNameKey) ? interpreter[firstNameKey]?.ToString()?.Trim() : "";
                                        var lastName = !string.IsNullOrEmpty(lastNameKey) ? interpreter[lastNameKey]?.ToString()?.Trim() : "";
                                        name = $"{firstName} {lastName}".Trim();
                                        if (string.IsNullOrEmpty(name)) name = "N/A";
                                    }
                                }
                                @name
                            </td>
                            <td>
                                @{
                                    var emailKey = interpreter.Keys.FirstOrDefault(k => k.Contains("Email", StringComparison.OrdinalIgnoreCase));
                                    var email = !string.IsNullOrEmpty(emailKey) ? interpreter[emailKey]?.ToString() : null;
                                }
                                @(email ?? "N/A")
                            </td>
                            <td>
                                @{
                                    var phoneKey = interpreter.Keys.FirstOrDefault(k => 
                                        k.Contains("Phone", StringComparison.OrdinalIgnoreCase) || 
                                        k.Contains("Tel", StringComparison.OrdinalIgnoreCase));
                                    var phone = !string.IsNullOrEmpty(phoneKey) ? interpreter[phoneKey]?.ToString() : null;
                                }
                                @(phone ?? "N/A")
                            </td>
                            <td>
                                @{
                                    var cityKey = interpreter.Keys.FirstOrDefault(k => k.Contains("City", StringComparison.OrdinalIgnoreCase));
                                    var city = !string.IsNullOrEmpty(cityKey) ? interpreter[cityKey]?.ToString() : null;
                                }
                                @(city ?? "N/A")
                            </td>
                            <td>
                                @{
                                    var stateKey = interpreter.Keys.FirstOrDefault(k => 
                                        k.Equals("State", StringComparison.OrdinalIgnoreCase) ||
                                        k.Contains("State", StringComparison.OrdinalIgnoreCase));
                                    var state = !string.IsNullOrEmpty(stateKey) ? interpreter[stateKey]?.ToString() : null;
                                }
                                @(state ?? "N/A")
                            </td>
                            <td>
                                @{
                                    var certKey = interpreter.Keys.FirstOrDefault(k => 
                                        k.Contains("Cert", StringComparison.OrdinalIgnoreCase) ||
                                        k.Contains("Credential", StringComparison.OrdinalIgnoreCase));
                                    var cert = !string.IsNullOrEmpty(certKey) ? interpreter[certKey]?.ToString() : null;
                                }
                                @(cert ?? "N/A")
                            </td>
                            <td>
                                @{
                                    var interpreterJson = System.Text.Json.JsonSerializer.Serialize(interpreter);
                                }
                                <form method="post" asp-page-handler="Register" style="display: inline;">
                                    <input type="hidden" name="interpreterData" value="@Html.Raw(interpreterJson)" />
                                    <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('Register this interpreter with the agency?')">Register</button>
                                </form>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            No interpreters found matching your search criteria.
        </div>
    }
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
